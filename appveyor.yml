version: 1.1.{build}
skip_tags: true
image: Visual Studio 2022
configuration: Release

environment:
  CODACY_PROJECT_TOKEN:
    secure: d9gOPuPA6l935Y61F82QoARJir9TvbJXXXV8oftNo7N3XEqHchsk1m8CJlGiE12D
  CODECLIMATE_TOKEN:
    secure: 7ylGPSQmstsISZGZtlexPldNrwl6z9yB1xRlQ0G+S5BnS+L4LXtAqTCkMl2IEkZhXoqwtHd+/9HGh1KJFx7g2biBhbzXs2335xhpo3i6Zos=
  SONAR_TOKEN:
    secure: 1p1JxwJ2ZeEVfXNWsKtV8wOWsHCJopjNMWzQa4wiofHTd9bVpdcEdJnPlUk1bS5X

dotnet_csproj:
  patch: true
  file: '**\*.csproj'
  version: '{version}'
  package_version: '{version}'
  assembly_version: '{version}'
  file_version: '{version}'
  informational_version: '{version}'

init:
  - SET JAVA_HOME=C:\Program Files\Java\jdk19
  - SET PATH=%JAVA_HOME%\bin;%PATH%

install:
  # If a newer build is queued for the same PR, cancel this one.
  # The AppVeyor 'rollout builds' option is supposed to serve the same
  # purpose, but it is problematic because it tends to cancel builds pushed
  # directly to main/master instead of just PR builds (or the converse).
  # credits: JuliaLang developers.
  - ps: if ($env:APPVEYOR_PULL_REQUEST_NUMBER -and $env:APPVEYOR_BUILD_NUMBER -ne ((Invoke-RestMethod `
        https://ci.appveyor.com/api/projects/$env:APPVEYOR_ACCOUNT_NAME/$env:APPVEYOR_PROJECT_SLUG/history?recordsNumber=50).builds | `
        Where-Object pullRequestId -eq $env:APPVEYOR_PULL_REQUEST_NUMBER)[0].buildNumber) { `
          throw "There are newer queued builds for this pull request, failing early." }

before_build:
  - ps: $env:SOLUTION_NAME = $([io.path]::GetFileNameWithoutExtension($(Get-ChildItem -Path .\* -Include *.sln)))
  - ps: $env:SONAR_PROJECT = "$env:APPVEYOR_REPO_NAME" -replace "/","_"
  - ps: $env:SONAR_ORGANIZATION = ("$env:APPVEYOR_REPO_NAME" -replace "/.*$","").toLower()
  - ps: $env:LOCAL_PR = 0
  - ps: if(-Not $env:APPVEYOR_PULL_REQUEST_NUMBER) { $env:LOCAL_PR = 1 }
  - ps: if($env:APPVEYOR_PULL_REQUEST_HEAD_REPO_NAME -Eq $env:APPVEYOR_REPO_NAME) { $env:LOCAL_PR = 1 }
  - cmd: nuget restore
  - cmd: choco install opencover.portable
  - cmd: choco install codecov
  - cmd: curl -L https://github.com/codacy/codacy-coverage-reporter/releases/latest/download/codacy-coverage-reporter-assembly.jar > ./codacy-test-reporter.jar
  - cmd: curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-windows-amd64 > codeclimate-test-reporter.exe
  - cmd: dotnet tool install --global dotnet-sonarscanner

build: off

build_script:
  - ps: $Params =  "/k:`"$env:SONAR_PROJECT`"", "/o:`"$env:SONAR_ORGANIZATION`"", "/v:`"$env:APPVEYOR_BUILD_NUMBER`""
  - ps: $Params += "/d:sonar.host.url=`"https://sonarcloud.io`""
  #- ps: if($env:LOCAL_PR -Eq 1) { $Params +=  "/d:sonar.token=`"$env:SONAR_TOKEN`"" }
  - ps: $Params += "/d:sonar.exclusions=`"**/bin/**/*,**/obj/**/*`"", "/d:sonar.coverage.exclusions=`"**/$env:SOLUTION_NAME.Tests/**,**/*Tests.cs`""
  - ps: $Params += "/d:sonar.cs.opencover.reportsPaths=`"Tests\$env:SOLUTION_NAME.Tests\coverage.net8.0.opencover.xml`""
  - ps: if(-Not $env:APPVEYOR_PULL_REQUEST_NUMBER) { $Params += "/d:sonar.branch.name=`"$env:APPVEYOR_REPO_BRANCH`"" }
  - ps: if($env:APPVEYOR_PULL_REQUEST_NUMBER) { $Params += "/d:sonar.pullrequest.key=$env:APPVEYOR_PULL_REQUEST_NUMBER", "/d:sonar.pullrequest.branch=`"$env:APPVEYOR_REPO_BRANCH`"" }
  - ps: Start-process "dotnet" "sonarscanner begin $($Params -join ' ')"
  - echo %Params%
  - codeclimate-test-reporter before-build
  - dotnet build --verbosity minimal %SOLUTION_NAME%.sln
  - ps: $TEST_PROJECTS = (Get-ChildItem -Path .\Tests\**\ -Recurse -Include *.csproj).Fullname
  - ps: |
      foreach($testProject in $TEST_PROJECTS)
      {
          dotnet test $testProject --no-build --verbosity minimal /p:CollectCoverage=true "/p:CoverletOutputFormat=\`"cobertura,opencover,lcov\`"" --logger:"junit;LogFilePath=test-results.xml"
          $path = Split-Path $testProject
          $wc = New-Object 'System.Net.WebClient'
          $wc.UploadFile("https://ci.appveyor.com/api/testresults/xunit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path $path/test-results.xml))
      }
  - if %LOCAL_PR% EQU 1 codecov -f "Tests\%SOLUTION_NAME%.Tests\coverage.net8.0.opencover.xml"
  - if %LOCAL_PR% EQU 1 codeclimate-test-reporter format-coverage -t lcov -o "Tests\%SOLUTION_NAME%.Tests\code-climate.json" "Tests\%SOLUTION_NAME%.Tests\coverage.net8.0.info"
  - if %LOCAL_PR% EQU 1 codeclimate-test-reporter upload-coverage -i "Tests\%SOLUTION_NAME%.Tests\code-climate.json" -r %CODECLIMATE_TOKEN%
  - if %LOCAL_PR% EQU 1 java -jar ./codacy-test-reporter.jar report -l CSharp -t %CODACY_PROJECT_TOKEN% -r "Tests\%SOLUTION_NAME%.Tests\coverage.net8.0.opencover.xml"
  - if %LOCAL_PR% EQU 1 dotnet sonarscanner end /d:sonar.token="%SONAR_TOKEN%"

after_build:
  - xcopy Tests\%SOLUTION_NAME%.Tests\*.xml Coverage\
  - xcopy Tests\%SOLUTION_NAME%.Tests\*.json Coverage\
  - xcopy Tests\%SOLUTION_NAME%.Tests\*.info Coverage\
  - 7z a -tzip -mx9 "%SOLUTION_NAME%.%APPVEYOR_BUILD_VERSION%.Coverage.zip" Coverage
  - appveyor PushArtifact "%SOLUTION_NAME%.%APPVEYOR_BUILD_VERSION%.Coverage.zip"

test: off

deploy:
  - provider: GitHub
    on:
      branch: main
    tag: v$(appveyor_build_version)
    description: "Release of $(SOLUTION_NAME) - v$(appveyor_build_version)"
    auth_token: $(GITHUB_TOKEN)
    force_update: true
